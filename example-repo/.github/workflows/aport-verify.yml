# APort Policy Verification Workflow
# This workflow verifies pull requests against APort agent policies
name: APort Verify

on:
  pull_request:
    types: [opened, synchronize, labeled, ready_for_review]
  workflow_dispatch:
    inputs:
      agent_id:
        description: "Agent ID to verify (optional, uses APORT_AGENT_ID secret if not provided)"
        required: false
        type: string

jobs:
  aport-verify:
    runs-on: ubuntu-latest
    name: Verify Agent Policy Compliance

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compute diff stats
        id: diff
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"
          FILES=$(git diff --name-only "$BASE" "$HEAD" | wc -l)
          LINES=$(git diff --shortstat "$BASE" "$HEAD" | awk '{print $4}')
          echo "files=${FILES:-0}" >> $GITHUB_OUTPUT
          echo "lines=${LINES:-0}" >> $GITHUB_OUTPUT

      - name: APort policy verification
        id: aport-check
        env:
          APORT_API_BASE: https://api.aport.io
          APORT_AGENT_ID: ${{ github.event.inputs.agent_id || secrets.APORT_AGENT_ID }}
        run: |
          echo "üîç Verifying agent: $APORT_AGENT_ID"
          echo "üìä Changes: ${{ steps.diff.outputs.files }} files, ${{ steps.diff.outputs.lines }} lines"

          # Build context payload
          BODY=$(jq -n \
            --arg id "$APORT_AGENT_ID" \
            --arg repo "${{ github.repository }}" \
            --arg branch "${{ github.event.pull_request.base.ref }}" \
            --arg actor "${{ github.actor }}" \
            --arg app "${{ github.app }}" \
            --argjson files ${{ steps.diff.outputs.files }} \
            --argjson lines ${{ steps.diff.outputs.lines }} \
            --argjson labels "$(jq -c '[.pull_request.labels[].name]' <<< '${{ toJson(github.event) }}')" \
            --argjson reviews "${{ github.event.pull_request.reviews.length || 0 }}" \
            --argjson draft "${{ github.event.pull_request.draft }}" \
            --argjson mergeable "${{ github.event.pull_request.mergeable }}" \
            '{agent_id:$id, context:{repo:$repo, base_branch:$branch, github_actor:$actor, github_app:$app, files_changed:$files, lines_added:$lines, labels:$labels, reviews:$reviews, is_draft:$draft, is_mergeable:$mergeable}}')

          echo "üì§ Sending policy verification request..."
          RESPONSE=$(curl -s -X POST "$APORT_API_BASE/api/verify/policy/code.repository.merge.v1" \
               -H "Content-Type: application/json" \
               -d "$BODY")

          echo "üì• APort Response: $RESPONSE"
          echo "response=$RESPONSE" >> $GITHUB_OUTPUT

          # Parse response
          ALLOW=$(echo "$RESPONSE" | jq -r '.allow // false')
          REASONS=$(echo "$RESPONSE" | jq -r '.reasons // []')

          if [ "$ALLOW" = "false" ]; then
            echo "‚ùå APort policy violation detected"
            echo "Reasons: $REASONS"
            exit 1
          else
            echo "‚úÖ APort policy check passed"
          fi

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.aport-check.outputs.response }}`;
            const allow = JSON.parse(response).allow;
            const reasons = JSON.parse(response).reasons || [];

            const status = allow ? "‚úÖ" : "‚ùå";
            const title = allow ? "APort Policy Check Passed" : "APort Policy Check Failed";
            const emoji = allow ? "üõ°Ô∏è" : "‚ö†Ô∏è";

            const comment = `${emoji} **${title}**

            **Agent:** \`${{ env.APORT_AGENT_ID }}\`
            **Actor:** \`${{ github.actor }}\`
            **Repository:** \`${{ github.repository }}\`
            **Branch:** \`${{ github.event.pull_request.base.ref }}\`

            ${allow 
              ? `This PR meets all APort policy requirements and is safe to proceed.`
              : `**Policy Violations:**\n${reasons.map(r => `- ${r}`).join('\n')}\n\nPlease review the policy requirements and update your PR accordingly.`
            }

            ---
            *Powered by [APort](https://aport.io) - Agent Identity Verification*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
